name: Build fuzzer target executable
on:
  workflow_dispatch:

jobs:
  build:
    name: Build and compile fuzzer target
    timeout-minutes: 120
    runs-on: self-hosted

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: 'true'

      - name: Setup Node.js 22.18
        uses: actions/setup-node@v4
        with:
          node-version: '22.18'

      - name: Enable Corepack (Yarn)
        run: corepack enable

      - name: Install dependencies
        run: yarn install --immutable

      - name: Build packages
        run: yarn build

      - name: Restore nexe build cache
        uses: actions/cache@v4
        with:
          # cache common nexe and node build caches to speed up repeated runs
          path: |
            ~/.cache/nexe
            ~/.nexe
            ~/.cache/node-gyp
          key: nexe-cache-${{ runner.os }}-${{ env.NODE_VERSION }}-${{ hashFiles('yarn.lock', 'package.json') }}
          restore-keys: |
            nexe-cache-${{ runner.os }}-${{ env.NODE_VERSION }}-
            nexe-cache-${{ runner.os }}-

      - name: Compile fuzzer target with nexe (package script)
        env:
          NODE_VERSION: 22.18.0
        run: |
          OUT=tsjam-fuzzer-target.tgz
          # expose the computed name to later steps
          echo "ARTIFACT_NAME=$OUT" >> $GITHUB_ENV
          # ensure a stable cache location for nexe build artifacts
          export XDG_CACHE_HOME="$HOME/.cache"
          export NEXE_CACHE_DIR="$HOME/.cache/nexe"
          mkdir -p "$NEXE_CACHE_DIR"

          ./build/build_fuzzer_target.sh

      - name: Untar and launch target in background
        shell: bash
        run: |
          set -euo pipefail
          : "${ARTIFACT_NAME:?ARTIFACT_NAME is required}"
          # Create a temporary directory and extract the built artifact
          TARGET_DIR="$(mktemp -d)"
          echo "Using temp dir: $TARGET_DIR"
          tar -xzf "$ARTIFACT_NAME" -C "$TARGET_DIR"

          cd $TARGET_DIR
          ls
          # Try common executable name first, otherwise discover any executable in the archive
          EXE="./tsjam-fuzzer-target/jam-fuzzer-target"
          if [[ -z "${EXE:-}" ]] || [[ ! -x "$EXE" ]]; then
            echo "No executable found in extracted artifact" >&2
            exit 1
          fi

          SOCKET_PATH="$TARGET_DIR/socket.sock"
          echo "SOCKET_PATH=$SOCKET_PATH" >> $GITHUB_ENV
          echo "Launching: $EXE with $SOCKET_PATH"
          nohup env JAM_CONSTANTS=tiny "$EXE" -s "$SOCKET_PATH" > "$RUNNER_TEMP/tsjam-target.log" 2>&1 &
          echo $! > "$GITHUB_WORKSPACE/.fuzzer_pid"
          echo "Background PID: $(cat "$GITHUB_WORKSPACE/.fuzzer_pid")"
          sleep 2
          cat $RUNNER_TEMP/tsjam-target.log

      - name: Run tests and stop target
        shell: bash
        run: |
          set -euo pipefail

          TEST_CMD="./build/test-target.sh"
          pwd;
          echo "Socket is: $SOCKET_PATH"
          set +e
          TEST_STATUS=1
          if [[ -n "$TEST_CMD" ]]; then
            $TEST_CMD -s $SOCKET_PATH
            TEST_STATUS=$?
          fi
          set -e

          # Stop background process regardless of test result
          if [[ -f .fuzzer_pid ]]; then
            PID="$(cat .fuzzer_pid)"
            echo "Stopping background PID: $PID"
            kill "$PID" 2>/dev/null || true
            for i in {1..10}; do
              if ! kill -0 "$PID" 2>/dev/null; then
                echo "Process $PID exited"
                break
              fi
              sleep 1
            done
            if kill -0 "$PID" 2>/dev/null; then
              echo "Force killing PID: $PID"
              kill -9 "$PID" 2>/dev/null || true
            fi
          else
            echo "No .fuzzer_pid file found; nothing to stop"
          fi

          # Fail step if tests failed (non-zero)
          if [[ $TEST_STATUS -ne 0 ]]; then
            echo "Test script exited with status: $TEST_STATUS" >&2
            exit $TEST_STATUS
          fi
      - name: Compute jamVersion and commit
        if: github.event_name != 'pull_request'
        id: compute_meta
        run: |
          set -euo pipefail
          jamVersion=$(node -p "require('./packages/jam-fuzzer-target/package.json')['jam:protocolVersion']")
          echo "jamVersion=$jamVersion" >> $GITHUB_ENV
          echo "commitSha=$(echo $GITHUB_SHA | cut -c1-8)" >> $GITHUB_ENV

      - name: Create draft release in vekexasia/tsjam-releases
        if: github.event_name != 'pull_request'
        uses: ncipollo/release-action@v1
        env:
          # Personal Access Token with repo scope stored in secrets
          RELEASES_TOKEN: ${{ secrets.RELEASES_TOKEN }}
        with:
          token: ${{ env.RELEASES_TOKEN }}
          owner: vekexasia
          repo: tsjam-releases
          tag: "${{ env.jamVersion }}"
          name: "${{ env.jamVersion }} - ${{env.commitSha}}"
          body: ${{ env.commitSha }}
          draft: false
          allowUpdates: true
          artifacts: ./${{ env.ARTIFACT_NAME }}
          artifactContentType: application/gzip
